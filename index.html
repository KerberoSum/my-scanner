<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Barcode Validator Pro</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --primary: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg: #f8fafc;
            --dark: #0f172a;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, system-ui, sans-serif;
            margin: 0; padding: 0; background-color: #000;
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        #scanner-wrapper {
            position: relative; height: 35vh; width: 100%;
            overflow: hidden; background: #000;
            display: flex; align-items: center; justify-content: center;
        }

        #reader { width: 100% !important; height: 100% !important; border: none !important; }
        #reader video { width: 100% !important; height: 100% !important; object-fit: cover !important; }

        /* Hide library UI */
        #reader__dashboard, #reader__header_message, #reader__status_span, 
        #reader__dashboard_section_swaplink, #reader__camera_selection,
        #reader img[alt="Info icon"], #reader img[alt="Camera icon"] { display: none !important; }

        #history-container {
            height: 65vh; display: flex; flex-direction: column;
            background: var(--bg); border-top-left-radius: 24px; border-top-right-radius: 24px;
            z-index: 10; padding: 20px; box-shadow: 0 -10px 20px rgba(0,0,0,0.3);
        }

        .controls-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 12px; }

        .btn-camera-toggle {
            flex-grow: 1; display: flex; align-items: center; justify-content: center;
            gap: 8px; padding: 14px; border-radius: 14px; font-weight: 600; border: none; cursor: pointer;
        }
        .camera-off { background: var(--primary); color: white; }
        .camera-on { background: var(--danger); color: white; }

        .history-list { flex-grow: 1; overflow-y: auto; }

        .scan-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px; background: white; border-radius: 12px; margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); border-left: 5px solid #cbd5e1;
        }

        /* Status Colors */
        .status-Approved { border-left-color: var(--success) !important; }
        .status-Not-Approved { border-left-color: var(--danger) !important; }
        .status-Re-pack { border-left-color: var(--warning) !important; }

        .code-val { display: block; font-family: monospace; font-weight: 700; font-size: 1.1rem; color: var(--dark); }
        
        .status-badge {
            font-size: 0.65rem; font-weight: 800; text-transform: uppercase;
            padding: 2px 8px; border-radius: 10px; margin-right: 8px;
        }
        .badge-Approved { background: #ecfdf5; color: var(--success); border: 1px solid #d1fae5; }
        .badge-Not-Approved { background: #fef2f2; color: var(--danger); border: 1px solid #fee2e2; }
        .badge-Re-pack { background: #fffbeb; color: var(--warning); border: 1px solid #fef3c7; }
        .badge-Unknown { background: #f1f5f9; color: #64748b; border: 1px solid #e2e8f0; }

        .code-time { font-size: 0.75rem; color: #94a3b8; }

        #flash {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: white; opacity: 0; pointer-events: none; z-index: 100;
        }
        .flash-active { animation: flash-anim 0.15s ease-out; }
        @keyframes flash-anim { 0% { opacity: 0.7; } 100% { opacity: 0; } }
    </style>
</head>
<body>

    <div id="scanner-wrapper">
        <div id="reader"></div>
        <div id="flash"></div>
    </div>

    <div id="history-container">
        <div class="controls-row">
            <button id="toggle-btn" onclick="toggleCamera()" class="btn-camera-toggle camera-off">
                <i data-lucide="camera" id="toggle-icon"></i>
                <span id="toggle-text">Start Scanning</span>
            </button>
            <button onclick="exportToCSV()" style="background:white; border:1px solid #e2e8f0; padding:14px; border-radius:14px;">
                <i data-lucide="download" style="width:18px; height:18px;"></i>
            </button>
        </div>

        <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
            <h2 style="margin:0; font-size: 0.8rem; color: #64748b; text-transform: uppercase;">Scans (<span id="count">0</span>)</h2>
            <button onclick="clearAll()" style="background:none; border:none; color: var(--danger); font-size: 0.8rem; font-weight: 600;">Clear All</button>
        </div>
        
        <div id="scans-list" class="history-list"></div>
    </div>

    <script>
        // --- PINPOINT: ADD YOUR BARCODES HERE ---
        const DATABASE = {
            APPROVED: ["123456", "789012", "ABC-100"],
            NOT_APPROVED: ["654321", "000000", "XYZ-999"],
            REPACK: ["555555", "111222", "RPK-500"]
        };

        let scanHistory = [];
        let lastCode = "";
        let lastTime = 0;
        let isScanning = false;
        const html5QrCode = new Html5Qrcode("reader");

        function getStatus(code) {
            if (DATABASE.APPROVED.includes(code)) return "Approved";
            if (DATABASE.NOT_APPROVED.includes(code)) return "Not Approved";
            if (DATABASE.REPACK.includes(code)) return "Re-pack";
            return "Unknown";
        }

        async function toggleCamera() {
            const btn = document.getElementById('toggle-btn');
            const text = document.getElementById('toggle-text');

            if (!isScanning) {
                try {
                    await html5QrCode.start(
                        { facingMode: "environment" }, 
                        { 
                            fps: 20, 
                            qrbox: (w, h) => ({ width: w * 0.8, height: w * 0.3 }),
                            aspectRatio: 1.0 
                        },
                        onScanSuccess
                    );
                    isScanning = true;
                    btn.className = "btn-camera-toggle camera-on";
                    text.innerText = "Stop Camera";
                } catch (err) { alert("Camera Error: " + err); }
            } else {
                await html5QrCode.stop();
                isScanning = false;
                btn.className = "btn-camera-toggle camera-off";
                text.innerText = "Start Scanning";
            }
        }

        function onScanSuccess(decodedText) {
            const now = Date.now();
            
            // --- PINPOINT: 1 SECOND INTERVAL LOGIC ---
            // If the code is the same as the last one, wait 1000ms (1s) before allowing another scan
            if (decodedText === lastCode && (now - lastTime) < 1000) {
                return;
            }

            lastCode = decodedText;
            lastTime = now;

            // Visual feedback (Flash)
            const flash = document.getElementById('flash');
            flash.classList.add('flash-active');
            setTimeout(() => flash.classList.remove('flash-active'), 150);
            
            // Haptic feedback
            if (navigator.vibrate) navigator.vibrate(70);

            // Determine Status
            const statusResult = getStatus(decodedText);

            // Add to history
            scanHistory.unshift({
                id: Date.now(),
                code: decodedText,
                status: statusResult,
                time: new Date().toLocaleTimeString()
            });
            
            renderList();
        }

        function renderList() {
            const list = document.getElementById('scans-list');
            document.getElementById('count').innerText = scanHistory.length;
            
            list.innerHTML = scanHistory.map(item => `
                <div class="scan-item status-${item.status.replace(' ', '-')}">
                    <div>
                        <span class="code-val">${item.code}</span>
                        <div style="margin-top:4px;">
                            <span class="status-badge badge-${item.status.replace(' ', '-')}">${item.status}</span>
                            <span class="code-time">${item.time}</span>
                        </div>
                    </div>
                    <button onclick="deleteItem(${item.id})" style="border:none; background:#fef2f2; color:var(--danger); padding:8px; border-radius:8px;">
                        <i data-lucide="trash-2" style="width:16px; height:16px;"></i>
                    </button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function deleteItem(id) {
            scanHistory = scanHistory.filter(item => item.id !== id);
            renderList();
        }

        function clearAll() {
            if (confirm("Clear history?")) {
                scanHistory = [];
                renderList();
            }
        }

        function exportToCSV() {
            if (scanHistory.length === 0) {
                alert("No data to export");
                return;
            }
            const csv = "Barcode,Status,Time\n" + scanHistory.map(e => `"${e.code}","${e.status}","${e.time}"`).join("\n");
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `barcode_scans_${new Date().toLocaleDateString()}.csv`;
            a.click();
        }

        lucide.createIcons();
    </script>
</body>
</html>
