<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Barcode Validator - Hardcoded DB</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --primary: #2563eb; --success: #10b981; --danger: #ef4444;
            --warning: #f59e0b; --bg: #f8fafc; --dark: #0f172a;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, system-ui, sans-serif;
            margin: 0; padding: 0; background-color: #000;
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        #scanner-wrapper { position: relative; height: 30vh; background: #000; }
        #reader { width: 100% !important; height: 100% !important; border: none !important; }
        
        #history-container {
            height: 70vh; display: flex; flex-direction: column;
            background: var(--bg); border-top-left-radius: 24px; border-top-right-radius: 24px;
            z-index: 10; padding: 16px; box-shadow: 0 -10px 20px rgba(0,0,0,0.3);
        }

        .stats-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: white; padding: 10px 15px; border-radius: 12px;
            margin-bottom: 15px; font-size: 0.85rem; font-weight: 600; color: #64748b;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .stat-highlight { color: var(--primary); font-weight: 800; }

        .action-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn {
            border: none; border-radius: 12px; padding: 12px; 
            font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-primary { background: var(--primary); color: white; flex: 2; }
        .btn-outline { background: white; border: 1px solid #e2e8f0; color: var(--dark); flex: 1; }
        .btn-stop { background: var(--danger); color: white; flex: 2; }

        .history-list { flex-grow: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .scan-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px; background: white; border-radius: 10px; margin-bottom: 8px;
            border-left: 4px solid #cbd5e1;
        }
        
        .status-Approved { border-left-color: var(--success); }
        .status-Not-Approved { border-left-color: var(--danger); }
        .status-Re-pack { border-left-color: var(--warning); }

        #flash {
            position: absolute; inset: 0; background: white; opacity: 0; 
            pointer-events: none; z-index: 100;
        }
        .flash-active { animation: flash-anim 0.15s ease-out; }
        @keyframes flash-anim { 0% { opacity: 0.7; } 100% { opacity: 0; } }
    </style>
</head>
<body>

    <div id="scanner-wrapper">
        <div id="reader"></div>
        <div id="flash"></div>
    </div>

    <div id="history-container">
        <div class="stats-bar">
            <span>Recent: <span id="visible-count" class="stat-highlight">0/50</span></span>
            <span>Session: <span id="total-count" class="stat-highlight">0</span></span>
        </div>

        <div class="action-row">
            <button id="toggle-btn" onclick="toggleCamera()" class="btn btn-primary">
                <i data-lucide="camera"></i> <span id="toggle-text">Start Camera</span>
            </button>
            <button onclick="exportToCSV()" class="btn btn-outline">
                <i data-lucide="download"></i> Export CSV
            </button>
        </div>

        <div id="scans-list" class="history-list"></div>
    </div>

    <script>
        // ============================================================
        // === DATABASE INPUT SECTION ===
        // Paste your barcodes inside the square brackets [ ]
        // Each barcode must be in quotes ' ' and separated by a comma.
        // ============================================================
        
        const RAW_APPROVED = [
            '8850001234567',
            '8850001234568',
            'SAMPLE001'
            // ... add thousands more here
        ];

        const RAW_NOT_APPROVED = [
            '9950001234567',
            'SAMPLE002'
            // ... add thousands more here
        ];

        const RAW_REPACK = [
            '7750001234567',
            'SAMPLE003'
            // ... add thousands more here
        ];

        // ============================================================
        // === END OF DATABASE INPUT ===
        // ============================================================

        // Convert arrays to Sets for high-performance O(1) lookups
        const DB = {
            APPROVED: new Set(RAW_APPROVED),
            NOT_APPROVED: new Set(RAW_NOT_APPROVED),
            REPACK: new Set(RAW_REPACK)
        };

        let scanHistory = [];
        let isScanning = false;
        const html5QrCode = new Html5Qrcode("reader");

        function getStatus(code) {
            if (DB.APPROVED.has(code)) return "Approved";
            if (DB.NOT_APPROVED.has(code)) return "Not Approved";
            if (DB.REPACK.has(code)) return "Re-pack";
            return "Unknown";
        }

        function renderList() {
            const listElement = document.getElementById('scans-list');
            const total = scanHistory.length;
            const visible = Math.min(total, 50);
            
            document.getElementById('visible-count').innerText = `${visible}/50`;
            document.getElementById('total-count').innerText = total;
            
            const displayItems = scanHistory.slice(0, 50);
            listElement.innerHTML = displayItems.map(item => `
                <div class="scan-item status-${item.status.replace(' ', '-')}">
                    <div>
                        <div style="font-family:monospace; font-weight:700; font-size:1.1rem;">${item.code}</div>
                        <div style="font-size:0.75rem; color:#64748b; margin-top:4px;">
                            <strong>${item.status}</strong> â€¢ ${item.time}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function exportToCSV() {
            if (scanHistory.length === 0) return alert("No scans to export");
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
            let csvContent = "Barcode,Status,Time\n";
            for (let i = 0; i < scanHistory.length; i++) {
                const e = scanHistory[i];
                csvContent += `"${e.code}","${e.status}","${e.time}"\n`;
            }
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `scans_${timestamp}.csv`;
            a.click();
            setTimeout(() => {
                if(confirm("Export complete. Clear history?")) {
                    scanHistory = [];
                    renderList();
                }
            }, 500);
        }

        async function toggleCamera() {
            const btn = document.getElementById('toggle-btn');
            if (!isScanning) {
                try {
                    await html5QrCode.start({ facingMode: "environment" }, 
                        { fps: 20, qrbox: (w, h) => ({ width: w * 0.8, height: h * 0.5 }) },
                        onScanSuccess
                    );
                    isScanning = true;
                    btn.className = "btn btn-stop";
                    document.getElementById('toggle-text').innerText = "Stop Camera";
                } catch (err) { alert("Camera Error: " + err); }
            } else {
                await html5QrCode.stop();
                isScanning = false;
                btn.className = "btn btn-primary";
                document.getElementById('toggle-text').innerText = "Start Camera";
            }
        }

        function onScanSuccess(decodedText) {
            // Debounce: ignore if same code scanned in last 2 seconds
            if (scanHistory.length > 0 && scanHistory[0].code === decodedText) return;

            document.getElementById('flash').classList.add('flash-active');
            setTimeout(() => document.getElementById('flash').classList.remove('flash-active'), 150);
            if (navigator.vibrate) navigator.vibrate(60);

            scanHistory.unshift({
                code: decodedText,
                status: getStatus(decodedText),
                time: new Date().toLocaleTimeString([], { hour12: false })
            });
            
            renderList();
        }

        lucide.createIcons();
    </script>
</body>
</html>
