<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Barcode Validator Pro</title>
    <!-- Libraries -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #2563eb; --success: #10b981; --danger: #ef4444;
            --warning: #f59e0b; --bg: #f1f5f9; --dark: #0f172a;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, system-ui, sans-serif;
            margin: 0; padding: 0; background-color: #000;
            height: 100vh; width: 100vw;
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* Top 30% - Scanner Section */
        #scanner-container { 
            position: relative; 
            height: 30vh; 
            width: 100%;
            background: #000;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #reader { 
            width: 100% !important; 
            height: 100% !important; 
            border: none !important;
        }
        #reader video {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover; 
        }

        /* Viewfinder Box */
        .viewfinder-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 240px;
            height: 60px; 
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 12px;
            z-index: 20;
            pointer-events: none;
            box-shadow: 0 0 0 1000px rgba(0,0,0,0.5); 
        }
        
        .viewfinder-box::after {
            content: '';
            position: absolute;
            inset: -2px;
            border: 3px solid var(--primary);
            border-radius: 12px;
            clip-path: polygon(0 0, 20% 0, 20% 10%, 80% 10%, 80% 0, 100% 0, 100% 30%, 90% 30%, 90% 70%, 100% 70%, 100% 100%, 80% 100%, 80% 90%, 20% 90%, 20% 100%, 0 100%, 0 70%, 10% 70%, 10% 30%, 0 30%);
        }

        .scan-line {
            position: absolute;
            top: 50%;
            left: 10%;
            width: 80%;
            height: 2px;
            background: rgba(37, 99, 235, 0.5);
            box-shadow: 0 0 8px var(--primary);
            z-index: 21;
            transform: translateY(-50%);
        }

        /* Bottom 70% - History Section */
        #history-container {
            height: 70vh;
            width: 100%;
            background: var(--bg);
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            z-index: 30;
            padding: 16px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 -10px 25px rgba(0,0,0,0.2);
        }

        .stats-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: white; padding: 10px 14px; border-radius: 12px;
            margin-bottom: 12px; font-size: 0.8rem; font-weight: 600; color: #64748b;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .stat-highlight { color: var(--primary); font-weight: 800; }

        .action-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr 1fr; 
            gap: 6px; 
            margin-bottom: 12px; 
        }
        
        /* Manual Input Section */
        .manual-input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            background: white;
            padding: 8px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .manual-input-group input {
            flex-grow: 1;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.9rem;
            outline: none;
        }
        .manual-input-group input:focus { border-color: var(--primary); }
        .btn-manual {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn {
            border: none; border-radius: 10px; padding: 10px 4px; 
            font-size: 0.75rem; font-weight: 700; cursor: pointer; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px;
            transition: all 0.2s;
        }
        .btn:active { transform: scale(0.95); opacity: 0.8; }
        
        .btn-primary { background: var(--primary); color: white; }
        .btn-stop { background: var(--dark); color: white; }
        .btn-outline { background: white; border: 1px solid #e2e8f0; color: var(--dark); }
        .btn-success-outline { background: #ecfdf5; border: 1px solid #a7f3d0; color: var(--success); }
        .btn-danger-outline { background: #fff1f2; border: 1px solid #fecaca; color: var(--danger); }
        .btn-danger-confirm { background: var(--danger); color: white; border: 1px solid var(--danger); }

        .history-list { 
            flex-grow: 1; 
            overflow-y: auto; 
            padding-right: 2px;
        }
        
        .scan-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px; background: white; border-radius: 12px; margin-bottom: 8px;
            border-left: 6px solid #cbd5e1;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        }
        
        .status-Approved { border-left-color: var(--success); }
        .status-Not-Approved { border-left-color: var(--danger); }
        .status-Re-pack { border-left-color: var(--warning); }
        .status-Unknown { border-left-color: #94a3b8; }

        .extra-info {
            font-size: 0.7rem;
            color: #64748b;
            background: #f8fafc;
            padding: 2px 6px;
            border-radius: 4px;
            margin-top: 4px;
            display: inline-block;
        }

        .btn-delete-single {
            background: #fee2e2; color: var(--danger);
            border: none; padding: 8px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
        }

        #flash {
            position: absolute; inset: 0; background: white; opacity: 0; 
            pointer-events: none; z-index: 100;
        }
        .flash-active { animation: flash-anim 0.15s ease-out; }
        @keyframes flash-anim { 0% { opacity: 0.6; } 100% { opacity: 0; } }

        #reader__dashboard, #reader img { display: none !important; }
        #excel-input { display: none; }
    </style>
</head>
<body>

    <div id="scanner-container">
        <div id="reader"></div>
        <div class="viewfinder-box">
            <div class="scan-line"></div>
        </div>
        <div id="flash"></div>
    </div>

    <div id="history-container">
        <div class="stats-bar">
            <span>DB: <span id="db-count" class="stat-highlight">0</span></span>
            <span>Total Scans: <span id="total-count" class="stat-highlight">0</span></span>
        </div>

        <div class="action-grid">
            <button id="toggle-btn" onclick="toggleCamera()" class="btn btn-primary">
                <i data-lucide="camera" style="width:16px;"></i> <span id="toggle-text">Start</span>
            </button>
            
            <button onclick="document.getElementById('excel-input').click()" class="btn btn-success-outline">
                <i data-lucide="file-up" style="width:16px;"></i> Import
            </button>
            <input type="file" id="excel-input" accept=".xlsx, .xls" onchange="handleImport(event)">

            <button onclick="exportToCSV()" class="btn btn-outline">
                <i data-lucide="download" style="width:16px;"></i> Export
            </button>
            
            <button id="clear-btn" onclick="handleClearAll()" class="btn btn-danger-outline">
                <i data-lucide="trash-2" style="width:16px;"></i> <span id="clear-text">Clear</span>
            </button>
        </div>

        <!-- Manual Input Box -->
        <div class="manual-input-group">
            <input type="text" id="manual-barcode" placeholder="Enter barcode manually..." onkeypress="if(event.key==='Enter') handleManualSubmit()">
            <button class="btn-manual" onclick="handleManualSubmit()">Submit</button>
        </div>

        <div id="scans-list" class="history-list">
            <div style="text-align:center; color:#94a3b8; margin-top:40px; font-size:0.9rem;">
                Import Excel or Start Scanning
            </div>
        </div>
    </div>

    <script>
        // === DATABASE STATE ===
        let masterDatabase = new Map(); 
        let scanHistory = [];
        let isScanning = false;
        let lastScanTime = 0;
        let clearConfirmTimeout = null;
        const html5QrCode = new Html5Qrcode("reader");

        // --- Excel Import Logic ---
        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                masterDatabase.clear();
                rows.forEach(row => {
                    const barcode = String(row[0] || '').trim();
                    if (barcode) {
                        masterDatabase.set(barcode, {
                            status: row[1] || 'Unknown',
                            info1: row[2] || '',
                            info2: row[3] || ''
                        });
                    }
                });

                document.getElementById('db-count').innerText = masterDatabase.size;
                alert(`Successfully imported ${masterDatabase.size} items.`);
                event.target.value = '';
            };
            reader.readAsArrayBuffer(file);
        }

        function getBarcodeData(code) {
            if (masterDatabase.has(code)) {
                return masterDatabase.get(code);
            }
            return { status: "Unknown", info1: "Not in database", info2: "" };
        }

        // --- Manual Input Handler ---
        function handleManualSubmit() {
            const input = document.getElementById('manual-barcode');
            const code = input.value.trim();
            if (!code) return;
            
            processBarcode(code);
            input.value = ''; // Clear input
            input.focus();
        }

        // --- Core Processing Logic ---
        function processBarcode(code) {
            const data = getBarcodeData(code);

            scanHistory.unshift({
                code: code,
                status: data.status,
                info1: data.info1,
                info2: data.info2,
                time: new Date().toLocaleTimeString([], { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' })
            });
            
            renderList();
        }

        // --- UI & History Logic ---
        function handleClearAll() {
            const btn = document.getElementById('clear-btn');
            const text = document.getElementById('clear-text');
            if (scanHistory.length === 0) return;

            if (btn.classList.contains('btn-danger-confirm')) {
                scanHistory = [];
                renderList();
                resetClearButton();
            } else {
                btn.className = "btn btn-danger-confirm";
                text.innerText = "Sure?";
                if (clearConfirmTimeout) clearTimeout(clearConfirmTimeout);
                clearConfirmTimeout = setTimeout(resetClearButton, 3000);
            }
        }

        function resetClearButton() {
            const btn = document.getElementById('clear-btn');
            const text = document.getElementById('clear-text');
            btn.className = "btn btn-danger-outline";
            text.innerText = "Clear";
            clearConfirmTimeout = null;
        }

        function deleteItem(index) {
            scanHistory.splice(index, 1);
            renderList();
        }

        function renderList() {
            const listElement = document.getElementById('scans-list');
            document.getElementById('total-count').innerText = scanHistory.length;
            
            if (scanHistory.length === 0) {
                listElement.innerHTML = `<div style="text-align:center; color:#94a3b8; margin-top:40px; font-size:0.9rem;">No scans yet</div>`;
                return;
            }

            listElement.innerHTML = scanHistory.slice(0, 50).map((item, index) => `
                <div class="scan-item status-${item.status.replace(/\s+/g, '-')}">
                    <div style="flex-grow: 1;">
                        <div style="font-family:monospace; font-weight:800; font-size:1rem; color:var(--dark);">${item.code}</div>
                        <div style="font-size:0.75rem; color:#64748b; margin-top:2px;">
                            <span style="color:${getStatusColor(item.status)}; font-weight:bold;">${item.status}</span> 
                            <span style="margin-left:8px; opacity:0.6;">${item.time}</span>
                        </div>
                        ${item.info1 || item.info2 ? `
                            <div class="extra-info">
                                ${item.info1} ${item.info2 ? ' | ' + item.info2 : ''}
                            </div>
                        ` : ''}
                    </div>
                    <button class="btn-delete-single" onclick="deleteItem(${index})">
                        <i data-lucide="trash-2" style="width:16px; height:16px;"></i>
                    </button>
                </div>
            `).join('');
            
            lucide.createIcons();
        }

        function getStatusColor(status) {
            if (status === 'Approved') return '#10b981';
            if (status === 'Not Approved') return '#ef4444';
            if (status === 'Re-pack') return '#f59e0b';
            return '#64748b';
        }

        function exportToCSV() {
            if (scanHistory.length === 0) return alert("No data to export");
            let csv = "Barcode,Status,Info1,Info2,Time\n" + 
                scanHistory.map(e => `"${e.code}","${e.status}","${e.info1}","${e.info2}","${e.time}"`).join("\n");
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `scan_report_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
        }

        // --- Camera Logic ---
        async function toggleCamera() {
            const btn = document.getElementById('toggle-btn');
            const text = document.getElementById('toggle-text');
            
            if (!isScanning) {
                try {
                    await html5QrCode.start(
                        { facingMode: "environment" }, 
                        { 
                            fps: 20, 
                            qrbox: { width: 240, height: 60 }, 
                            aspectRatio: 1.0 
                        },
                        onScanSuccess
                    );
                    isScanning = true;
                    btn.className = "btn btn-stop";
                    text.innerText = "Stop";
                } catch (err) { alert("Camera failed: " + err); }
            } else {
                await html5QrCode.stop();
                isScanning = false;
                btn.className = "btn btn-primary";
                text.innerText = "Start";
            }
        }

        function onScanSuccess(decodedText) {
            const now = Date.now();
            if (now - lastScanTime < 1000) return; 
            lastScanTime = now;

            const flash = document.getElementById('flash');
            flash.classList.remove('flash-active');
            void flash.offsetWidth; 
            flash.classList.add('flash-active');
            
            if (navigator.vibrate) navigator.vibrate(50);

            processBarcode(decodedText);
        }

        lucide.createIcons();
    </script>
</body>
</html>
